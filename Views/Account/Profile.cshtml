@model fleurDamour.Models.Account

@{
    ViewData["Title"] = "Profile";
    fleurDamour.Models.FleurDamourContext db = new();
    string userName = HttpContextAccessor.HttpContext.Session.GetString("UserName");
    Account UserAcc = db.Accounts.SingleOrDefault(a => a.UserName == userName);
}

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<style>
    body {
        background: #60a3bc;
        background-size: cover;
        background-attachment: fixed;
    }

    .breadcumb-area {
        height: auto;
        padding: 120px 0 500px 0;
        background-size: cover;
        background-position: center;
        position: relative;
    }

    .profile-header {
        margin-top: 70px;
        position: relative;
        overflow: hidden;
    }

    .profile-header-content,
    .profile-header-tab,
    .profile-header-img {
        position: relative;
    }

        .profile-header-img img {
            max-width: 20%;
            border-radius: 50%;
            border: 4px solid #fff;
        }

            .profile-header-img img:hover {
                transform: scale(1.1); /* Phóng to khi hover */
                transition: transform 0.3s ease;
            }

    .profile-header-tab {
        list-style-type: none;
        padding-left: 0;
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
        border-bottom: 2px solid #c8c7cc;
    }

        .profile-header-tab > li {
            margin: 10px;
        }

            .profile-header-tab > li > a {
                color: white;
                padding: 10px 20px;
                text-decoration: none;
                font-weight: bold;
                border: 2px solid transparent;
                border-radius: 20px;
                transition: all 0.3s ease;
            }

                .profile-header-tab > li.active > a,
                .profile-header-tab > li > a:hover {
                    color: black;
                    border-color: #007aff;
                }

    .profile-header-content {
        color: #fff;
        padding: 20px;
        text-align: center;
    }

    .profile-header-info h4{
        color: white;
        font-size: 3rem;
    }

    .card {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .card-header {
        background: #6a7766;
        color: #fff;
        border-bottom: 1px solid #c8c7cc;
    }
    .card-header h3{
        color : white;
    }

    .card-body {
        padding: 20px;
    }

    .btn-primary {
        background-color: #1D85FC;
        border: none;
        border-radius: 5px;
        transition: background-color 0.2s;
    }

        .btn-primary:hover {
            background-color: #0056b3;
        }
</style>
<section class="breadcumb-area bg-img bg-overlay" style="background-image: url('@Url.Content("~/img/image/3.png")');">
    
<div class="w3-container">
    <div id="content" class="content p-0">
        <div class="profile-header">
            <div class="profile-header-cover"></div>
            <div class="container profile-header-content">
                <div class="profile-header-img">
                    <img style="height:100%;width:100%" src="@Model.PicAccount" alt="Avatar" />
                </div>
                <div class="profile-header-info">
                    <h4 class="m-t-sm">@Model.AccountName</h4>
                </div>
                <div>
                    <ul class="profile-header-tab nav nav-tabs">
                        <li class="nav-item"><a href="#" class="nav-link" id="aboutTab">ABOUT</a></li>
@*                         <li class="nav-item"><a href="#" class="nav-link" id="historyTab">HISTORY</a></li> *@
                        <li class="nav-item"><a href="#" class="nav-link" id="orderTab">ORDERS</a></li>
                        <li class="nav-item"><a href="#" class="nav-link" id="cartTab">SHOPPING CART</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- About Section -->
<div class="container mt-4 mb-5" id="aboutContent">
    <div class="card bg-light shadow">
        <div class="card-header text-center" style="border-radius: 15px 15px 0 0;">
            <h4>@Model.AccountName's Profile</h4>
        </div>
        <div class="card-body">
            <div class="profile-info-item mb-3">
                <span class="profile-info-icon"><i class="fas fa-user"></i></span>
                <span class="profile-info-text">Account Name: @Model.AccountName</span>
            </div>
            <div class="profile-info-item mb-3">
                <span class="profile-info-icon"><i class="fas fa-envelope"></i></span>
                <span class="profile-info-text">Email: @Model.Email</span>
            </div>
            <div class="profile-info-item mb-3">
                <span class="profile-info-icon"><i class="fas fa-phone"></i></span>
                <span class="profile-info-text">Phone: @Model.Phone</span>
            </div>
            <div class="profile-info-item mb-3">
                <span class="profile-info-icon"><i class="fas fa-map-marker-alt"></i></span>
                <span class="profile-info-text">Address: @Model.Address</span>
            </div>
            <div class="profile-info-item mb-3">
                <span class="profile-info-icon"><i class="fas fa-calendar-alt"></i></span>
                <span class="profile-info-text">Date of Birth: @Model.DateOfBirth?.ToString("dd/MM/yyyy")</span>
            </div>

            @if (UserAcc != null && UserAcc.UserName == Model.UserName)
            {
                <div class="d-flex justify-content-center mt-3">
                    <a href="#editModal" class="btn btn-primary" data-toggle="modal">Edit Profile</a>
                </div>
            }
        </div>
    </div>
</div>

@* <!-- History Section -->
<div class="container mt-4 mb-5" id="historyContent" style="display: none">
    <div class="card">
        <div class="card-header text-center">
            <h3>Purchase History</h3>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Order Date</th>
                        <th>Total Price</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        List<fleurDamour.Models.Order> historyOrders;
                        try
                        {
                            // Truy vấn các đơn hàng liên kết với Account qua bảng History
                            historyOrders = db.Accounts
                            .Where(a => a.Uid == Model.Uid)
                            .SelectMany(a => a.Idorders) // Lấy danh sách Orders từ mối quan hệ nhiều-nhiều
                            .OrderByDescending(o => o.OrderDay)
                            .ToList() ?? new List<fleurDamour.Models.Order>();
                        }
                        catch (Exception)
                        {
                            historyOrders = new List<fleurDamour.Models.Order>();
                        }
                    }
                    @if (historyOrders.Any())
                    {
                        @foreach (var order in historyOrders)
                        {
                            <tr>
                                <td>@order.Idorder</td>
                                <td>@order.OrderDay?.ToString("dd/MM/yyyy")</td>
                                <td>@order.TotalPrice</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3">No purchase history available.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div> *@
<!-- Orders Section -->
<div class="container mt-4 mb-5" id="orderContent" style="display: none">
    <div class="card">
        <div class="card-header text-center">
            <h3>Your Orders</h3>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Order Date</th>
                        <th>Total Price</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var orders = db.Orders.Where(o => o.Uid == Model.Uid).OrderByDescending(o => o.OrderDay).ToList();
                    }
                    @foreach (var item in orders)
                    {
                        <tr>
                            <td>@item.Idorder</td>
                            <td>@item.OrderDay?.ToString("dd/MM/yyyy")</td>
                            <td>@item.TotalPrice</td>
                            <td><a href="#orderDetailModal_@item.Idorder" class="btn btn-sm btn-primary" data-toggle="modal">View</a></td>
                        </tr>                        
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Shopping Cart Section -->
<div class="container mt-4 mb-5" id="cartContent" style="display: none">
    <div class="card">
        <div class="card-header text-center">
            <h3>Shopping Cart</h3>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Image</th>
                        <th>Quantity</th>
                        <th>Add Date</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var cartItems = db.ShoppingCarts.Where(sc => sc.Uid == Model.Uid).OrderByDescending(sc => sc.AddDate).ToList();
                    }
                    @foreach (var item in cartItems)
                    {
                        var product = db.Products.SingleOrDefault(p => p.Idproduct == item.Idproduct);
                        <tr>
                            <td>@product?.NameProduct</td>
                            <td><img src="@product?.ImgProduct" alt="Product Image" style="width: 50px; height: 50px; border-radius: 50%;" /></td>
                            <td>@item.Quantity</td>
                            <td>@item.AddDate?.ToString("dd/MM/yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
</section>
<!-- Edit Profile Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form asp-action="EditProfile" method="post" enctype="multipart/form-data" class="form-group">
                <div class="modal-body">
                    <h5 class="modal-title" id="editModalLabel">
                        Edit Profile
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </h5>
                    <hr />
                    <input type="hidden" name="Uid" value="@Model.Uid" />
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                        </div>
                        <input class="form-control" placeholder="Account Name: @Model.AccountName" name="AccountName" value="@Model.AccountName">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        </div>
                        <input class="form-control" placeholder="Email: @Model.Email" name="Email" value="@Model.Email">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        </div>
                        <input class="form-control" placeholder="Phone: @Model.Phone" name="Phone" value="@Model.Phone">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                        </div>
                        <input class="form-control" placeholder="Address: @Model.Address" name="Address" value="@Model.Address">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                        </div>
                        <input class="form-control" type="file" id="fileUpload" name="PicAccount" accept="image/*">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        </div>
                        <input class="form-control" type="date" value="@Model.DateOfBirth?.ToString("yyyy-MM-dd")" name="DateOfBirth">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var historyVisible = false;
            var orderVisible = false;
            var cartVisible = false;
            var aboutVisible = false;

            $("#historyTab").click(function () {
                if (!historyVisible) {
                    $("#aboutContent").slideUp();
                    $("#aboutTab").removeClass("active");
                    $("#orderContent").slideUp();
                    $("#orderTab").removeClass("active");
                    $("#cartContent").slideUp();
                    $("#cartTab").removeClass("active");
                    $("#historyContent").slideDown();
                    $(this).addClass("active");
                    historyVisible = true;
                    aboutVisible = false;
                    orderVisible = false;
                    cartVisible = false;
                }
            });

            $("#orderTab").click(function () {
                if (!orderVisible) {
                    $("#aboutContent").slideUp();
                    $("#aboutTab").removeClass("active");
                    $("#historyContent").slideUp();
                    $("#historyTab").removeClass("active");
                    $("#cartContent").slideUp();
                    $("#cartTab").removeClass("active");
                    $("#orderContent").slideDown();
                    $(this).addClass("active");
                    orderVisible = true;
                    aboutVisible = false;
                    historyVisible = false;
                    cartVisible = false;
                }
            });

            $("#cartTab").click(function () {
                if (!cartVisible) {
                    $("#aboutContent").slideUp();
                    $("#aboutTab").removeClass("active");
                    $("#historyContent").slideUp();
                    $("#historyTab").removeClass("active");
                    $("#orderContent").slideUp();
                    $("#orderTab").removeClass("active");
                    $("#cartContent").slideDown();
                    $(this).addClass("active");
                    cartVisible = true;
                    aboutVisible = false;
                    historyVisible = false;
                    orderVisible = false;
                }
            });

            $("#aboutTab").click(function () {
                if (!aboutVisible) {
                    $("#historyContent").slideUp();
                    $("#historyTab").removeClass("active");
                    $("#orderContent").slideUp();
                    $("#orderTab").removeClass("active");
                    $("#cartContent").slideUp();
                    $("#cartTab").removeClass("active");
                    $("#aboutContent").slideDown();
                    $(this).addClass("active");
                    aboutVisible = true;
                    historyVisible = false;
                    orderVisible = false;
                    cartVisible = false;
                }
            });
        });
    </script>
}